<!doctype html>
<html lang="en">

<head>
	<!-- Required meta tags -->
	<meta charset="utf-8">
	<meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

	<!-- Bootstrap CSS -->
	<link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/4.0.0/css/bootstrap.min.css"
		integrity="sha384-Gn5384xqQ1aoWXA+058RXPxPg6fy4IWvTNh0E263XmFcJlSAwiGgFAW/dAiS6JXm" crossorigin="anonymous">

	<title>TIMining Aware - Inchancables</title>
	
	<!-- jQuery first, then Popper.js, then Bootstrap JS -->
	<script src="https://code.jquery.com/jquery-3.6.0.min.js"
		integrity="sha256-/xUj+3OJU5yExlq6GSYGSHk7tPXikynS7ogEvDej/m4=" crossorigin="anonymous"></script>
	<script src="https://cdnjs.cloudflare.com/ajax/libs/popper.js/1.12.9/umd/popper.min.js"
		integrity="sha384-ApNbgh9B+Y1QKtv3Rn7W3mgPxhU9K/ScQsAP7hUibX39j7fakFPskvXusvfa0b4Q" crossorigin="anonymous">
	</script>
	<script src="https://maxcdn.bootstrapcdn.com/bootstrap/4.0.0/js/bootstrap.min.js"
		integrity="sha384-JZR6Spejh4U02d8jOt6vLEHfe/JQGiRRSQQxSfFWpi1MquVdAyjUar5+76PVCmYl" crossorigin="anonymous">
	</script>
</head>

<body>
	<form class="needs-validation" novalidate>
		<div class="form-row">
			<div class="col-md-3 mb-3">
				<label for="formInchancableName">Nombre de inchancable</label>
				<input type="text" class="form-control" id="formInchancableName" placeholder="inf5.inch01" value=""
					required>
				<div class="invalid-feedback">
					Por favor ingresar un nombre
				</div>
			</div>
			<div class="col-md-3 mb-3">
				<label for="formInchancableType">Tipo de inchancable</label>
				<select class="form-control" id="formInchancableType" required>
					<option value="">Selecciona el tipo</option>
					<option value="alpha">Tipo Alfa</option>
					<option value="beta">Tipo Beta</option>
					<option value="gamma">Tipo Gamma</option>
				</select>
				<div class="invalid-feedback">
					Por favor selecciona el tipo de inchancable
				</div>
			</div>
		</div>
		<div class="form-row">
			<div class="col-md-3 mb-3">
				<label for="formInchancableNorth">Norte</label>
				<input type="number" step="0.0000001" min="0" class="form-control" id="formInchancableNorth"
					placeholder="100580.0455" required>
				<div class="invalid-feedback">
					Por favor ingrese una coordenada válida.
				</div>
			</div>
			<div class="col-md-3 mb-3">
				<label for="formInchancableEast">Este</label>
				<input type="number" step="0.0000001" min="0" class="form-control" id="formInchancableEast"
					placeholder="100007.130" required>
				<div class="invalid-feedback">
					Por favor ingrese una coordenada válida.
				</div>
			</div>
			<div class="col-md-3 mb-3">
				<label for="formInchancableHeight">Cota</label>
				<input type="number" step="0.0000001" min="0" class="form-control" id="formInchancableHeight"
					placeholder="3400.0" required>
				<div class="invalid-feedback">
					Por favor ingrese una coordenada válida.
				</div>
			</div>
		</div>
		<button class="btn btn-primary" type="submit">Submit form</button>
		<button class="btn btn-secondary" type="button" onclick="clearUncrushables()">Eliminar todos</button>
	</form>

	<script>
		let serverInstance = "https://tima-millipede.dt.timlabtesting.com";
		let serverApiKey = "435ced52-19b6-4c9c-a77e-64da7ca7319f";
		let remoteDocumentType = "raw_uncrushables"

		let items = []; // stores all uncrushable items


		// Example starter JavaScript for disabling form submissions if there are invalid fields
		(function () {
			'use strict';
			window.addEventListener('load', function () {
				// Fetch all the forms we want to apply custom Bootstrap validation styles to
				var forms = document.getElementsByClassName('needs-validation');
				// Loop over them and prevent submission
				var validation = Array.prototype.filter.call(forms, function (form) {
					form.addEventListener('submit', function (event) {
						if (form.checkValidity() === false) {
							event.preventDefault();
							event.stopPropagation();
						} else {
							fetchAndSendUncrushables();
						}

						event.preventDefault();
						// return false;
						form.classList.add('was-validated');
						
					}, false);
				});
			}, false);
		})();

		async function fetchAndSendUncrushables() {
			try {
				let uncrushableDoc = await getLatestUncrushableDocument();
				items = [];

				let newUncrushable = createNewUncrushable();
				items.push(newUncrushable);
				
				$(uncrushableDoc).each((idx, item) => {
					// skip old uncrushable if it has the same name
					if (item.name !== newUncrushable.name) 
						items.push(item);
				});

				await sendUncrushables();
				alert(`Envío completado con éxito. Hay ${items.length} inchancables ingresados`);
			} catch (ex) {
				alert('Ocurrió un error. Favor intentar nuevamente');
				console.log(ex);
			}
		}

		async function clearUncrushables() {
			try {
				if (confirm("Estás seguro que deseas eliminar todos los datos existentes?")) {
					items = [];
					await sendUncrushables();
					alert("Datos eliminados con éxito");

				}
			} catch (ex) {
				alert('Ocurrió un error. Favor intentar nuevamente');
				console.log(ex);
			}
		}

		function getLatestUncrushableDocument() {
			let url = `${serverInstance}/assets/remote-document/query/${remoteDocumentType}`;

			let request = {
				url: url,
				type: 'GET',
				dataType: 'json'
			}
			addApiKeyIfNeeded(request);

			return $.ajax(request);
		}

		function createNewUncrushable() {
			let itemToAdd = {
				"name": $("#formInchancableName").val(),
				"type": $("#formInchancableType").val(),
				"north": $("#formInchancableNorth").val(),
				"east": $("#formInchancableEast").val(),
				"height": $("#formInchancableHeight").val()
			};

			return itemToAdd;
		}

		function sendUncrushables() {
			let url = `${serverInstance}/assets/remote-document/${remoteDocumentType}`;
			let request = {
				url: url,
				type: 'POST',
				dataType: 'json',
				contentType: "application/json; charset=utf-8",
				data: JSON.stringify(items)
			};

			addApiKeyIfNeeded(request);

			return $.ajax(request);

		}

		function addApiKeyIfNeeded(request){
			if (serverApiKey !== "") {
				request.beforeSend = (xhr) => {
					xhr.setRequestHeader('x-api-key', serverApiKey);
				}
			}
		}
	</script>

</body>

</html>